@page "/SignalChat"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.SignalR.Client
@using StudentTimeTrackerApp.Hubs
@inject NavigationManager navigationManager

@{
    /// Primarily Sourced from https://www.c-sharpcorner.com/article/building-a-real-time-chat-application-with-signalr-in-blazor-net-9/

    /// Additional sourcing, which specializes in a split client-server model, where ChatHub.cs is placed on the Server: https://github.com/dotnet/blazor-samples/blob/main/9.0/BlazorSignalRApp/BlazorSignalRApp.Client/Pages/Chat.razor
}

<h3>Chat Application</h3>

@* <div>
    <input @bind="_UserName" placeholder="Enter your name" />
    <input @bind="_newMessage" placeholder="Enter your message" @onkeypress="SendOnEnter" />
    <button @onclick="SendMessage" disabled="@(!IsConnected)">Send</button>
</div>

<div style="margin-top: 20px;">
    <h4>Messages:</h4>
    <ul>
        @foreach (var message in _Messages)
        {
            <li>@message</li>
        }
    </ul>
</div>
 *@



<!-- ................. -->
@if (!_isChatting)
{
    <p>
        Enter your name to start chatting:
    </p>

    <input type="text" maxlength="32" @bind="@_UserName" />
    <button type="button" @onclick="@Chat"><span class="oi oi-chat" aria-hidden="true"></span> Chat!</button>

    // Error messages
    @if (_message != null)
    {
        <div class="invalid-feedback">@_message</div>
        <small id="emailHelp" class="form-text text-muted">@_message</small>
    }
}
else
{
    // banner to show current user
    <div class="alert alert-secondary mt-4" role="alert">
        <span class="oi oi-person mr-2" aria-hidden="true"></span>
        <span>You are connected as <b>@_UserName</b></span>
        <button class="btn btn-sm btn-warning ml-md-auto" @onclick="@DisconnectAsync">Disconnect</button>
    </div>

    <h2>Connected users:</h2>
    <ul>
        @foreach (var user in _connectedUsers)
        {
            <li>@user</li>
        }
    </ul>

    // display messages
    <div id="scrollbox">
        @foreach (var item in _Messages)
        {
            @if (item.IsNotice)
            {
                <div class="alert alert-info">@item.Body</div>
            }
            else
            {
                <div class="@item.CSS">
                    <div class="user">From: @item.Username</div>
                    @if (!string.IsNullOrWhiteSpace(item.RecieverUsername))
                    {
                        <div class="user">To: @item.RecieverUsername</div>
                    }
                    <div class="msg">@item.Body</div>
                </div>
            }
        }
        <hr />
        <div id="sentto">
            <label for="recipientUsername">Send message to:</label>
            <input type="text" id="recipientUsername" @bind="_recipientUsername" />
        </div>
        <textarea class="input-lg" placeholder="enter your comment" @bind="@_newMessage"></textarea>
        
        @* Breakpoints  can be placed here! 
            |
            V   *@
        <button class="btn btn-default" @onclick="@(() => SendAsync(_newMessage))">Send</button>
    </div>
}




@code {
    /// <summary>
    /// temporary local class that should be wired up with the Entity Model at some point
    /// </summary>
    private class midMessage
    {
        /// <summary>
        /// Create a temporary local class for messages
        /// </summary>
        /// <param name="username"></param>
        /// <param name="body"></param>
        /// <param name="mine"></param>
        /// <param name="courseId"></param>
        public midMessage(string username, string body, bool mine, int courseId)
        {
            Username = username;
            Body = body;
            Mine = mine;
            CourseId = courseId;
        }
        /// <summary>
        /// Sender
        /// </summary>
        public string Username { get; set; }
        /// <summary>
        /// Recipient
        /// </summary>
        public string RecieverUsername { get; set; }

        public int CourseId { get; set; }

        /// <summary>
        /// Body
        /// </summary>
        public string Body { get; set; }
        public bool Mine { get; set; }

        public bool IsNotice => Body.StartsWith("[Notice]");

        public string CSS => Mine ? "sent" : "received";
    }


    [Parameter]
    public required string UserName { get; set; }

    [Parameter]
    public string? Recipient { get; set; } = string.Empty;

    [Parameter]
    public required int CourseId { get; set; }


    // flag to indicate chat status
    private bool _isChatting = false;

    // name of user that will be chatting
    private string? _UserName;

    private int? _CourseId;

    // on-screen message
    private string _message;

    // on-screen recipientUsername
    private string _recipientUsername;

    // new message input
    private string? _newMessage;

    // list to hold messages in chat
    private List<midMessage> _Messages = new();

    // list of Users in chat
    private List<string> _connectedUsers = new List<string>(); //NOTE: it might be worth checking the Type of this list later

    private HubConnection? _hubConnection;
    private string _hubUrl;

    // protected override async Task OnInitializedAsync()
    // {


    // }

    private async Task Chat()
    {
        // initialize the private fields from the parameters
        _UserName = UserName?.Trim();
        _recipientUsername = Recipient?.Trim();
        _CourseId = CourseId;


        if (string.IsNullOrWhiteSpace(_UserName))
        {
            _message = "Please enter a name";
            return;
        }

        try {
        //await OnInitializedAsync();

        // check username is valid

            // Start chatting and force refresh UI, ref: https://github.com/dotnet/aspnetcore/issues/22159
        _isChatting = true;
        await Task.Delay(1);

        // remove old messages if any
        _Messages.Clear();

        // Create the chat client
        string baseUrl = navigationManager.BaseUri;
        _hubUrl = baseUrl.TrimEnd('/') + ChatHub.HubUrl;


        // Create the connection
        _hubConnection = new HubConnectionBuilder()
            .WithUrl($"{_hubUrl}?username={_UserName}")
            //.WithUrl(_hubUrl) //navigationManager.ToAbsoluteUri("/chathub"))
            .WithAutomaticReconnect()
            .Build();

        /*
        *
        *   // Listen to incoming messages, uses an inline lambda method to process messages
        *   _hubConnection.On<string, string>("ReceiveMessage", (user, message) =>
        *   {
            *       var encodedMsg = $"{user}: {message}";
            *       _Messages.Add($"{user}: {message}");
            *       InvokeAsync(StateHasChanged);
            *   });
        */

        // Define event handlers for SignalR events
        _hubConnection.On<string, string, int>("Broadcast", BroadcastMessage); // sends to all clients
        _hubConnection.On<string, string, string, int>("SendToUser", SendToUser); // sends to specific user
        _hubConnection.On<IEnumerable<string>>("UpdateConnectedUsers", (userList) =>
            {
                _connectedUsers = userList.ToList();
                InvokeAsync(StateHasChanged);
            });

        // Start the connection
        await _hubConnection.StartAsync();
        // Notify others of new user
        await SendAsync($"[Notice] {_UserName} joined chat room.");

        }
        catch (Exception e)
        {
            _message = $"ERROR: Failed to start chat client: {e.Message}";
            _isChatting = false;
        }
    }





    /// <summary>
    /// Send a message to all connected users
    /// </summary>
    /// <param name="name"></param>
    /// <param name="message"></param>
    private void BroadcastMessage(string name, string message, int courseId)
    {
        bool isMine = name.Equals(_UserName, StringComparison.OrdinalIgnoreCase);

        _Messages.Add(new midMessage(name, message, isMine, courseId));

        // Inform blazor the UI needs updating
        InvokeAsync(StateHasChanged);
    }


    /// <summary>
    /// Send a message to a specific user
    /// </summary>
    /// <param name="senderUsername"></param>
    /// <param name="recieverUsername"></param>
    /// <param name="messageBody"></param>
    private void SendToUser(string senderUsername, string recieverUsername, string messageBody, int courseId)
    {
        bool isMine = senderUsername.Equals(_UserName, StringComparison.OrdinalIgnoreCase);
        var messageObj = new midMessage(senderUsername, messageBody, isMine, courseId);
        messageObj.RecieverUsername = recieverUsername;
        _Messages.Add(messageObj);

        // Inform blazor the UI needs updating
        InvokeAsync(StateHasChanged);
    }




    private async Task DisconnectAsync()
    {
        if (_isChatting)
        {
            await SendAsync($"[Notice] {_UserName} left chat room.");

            await _hubConnection.StopAsync();
            await DisposeAsync();

            _hubConnection = null;
            _isChatting = false;
        }
    }


    /// <summary>
    /// Facilitates sending a message using the private _newMessage field. Allows to sidestep passing a variable to SendAsync()
    /// </summary>
    /// <returns></returns>
    private async Task SendMessage()
    {
        if (_isChatting &&
            !string.IsNullOrWhiteSpace(_UserName) &&
            !string.IsNullOrEmpty(_newMessage) &&
            _hubConnection is not null)
        {
            await SendAsync(_newMessage);
        }
    }



    /// <summary>
    /// Handles how a message is sent to the hub
    /// </summary>
    /// <param name="message"></param>
    /// <returns></returns>
    private async Task SendAsync(string message)
    {
        if (_isChatting && !string.IsNullOrWhiteSpace(message) && _hubConnection is not null)
        {
            // ChatHub handles how the message is routed based on the inputs
            //      Breakpoints should be placed in /Hubs/ChatHub.cs
            await _hubConnection.SendAsync("Broadcast", _UserName, _recipientUsername, message, _CourseId);
            


            // clear the message input box
            _newMessage = string.Empty;
        }
    }



    private async Task SendOnEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }





    public bool IsConnected =>
        _hubConnection?.State == HubConnectionState.Connected;

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}